<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bentley Geospatial Explorer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #ffffff;
      --accent-dark: #e0e0e0;
      --bg-dark: #0a0a0a;
      --bg-panel: #111111;
      --bg-card: #1a1a1a;
      --bg-hover: #222222;
      --border: #2e2e2e;
      --text: #f0f0f0;
      --text-muted: #888888;
      --danger: #ff4444;
      --warning: #ffaa00;
      --accent-color: #ffffff;
      --btn-bg: #ffffff;
      --btn-text: #0a0a0a;
      --btn-hover: #e0e0e0;
    }

    html, body { height: 100%; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-dark); color: var(--text); }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      height: 52px; background: #000000;
      border-bottom: 1px solid #2e2e2e;
      display: flex; align-items: center; padding: 0 20px; gap: 16px;
    }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 16px; letter-spacing: .3px; }
    .logo-icon { width: 30px; height: 30px; background: #ffffff; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
    .logo-text { color: var(--text); font-weight: 700; letter-spacing: .5px; text-transform: uppercase; font-size: 14px; }
    .logo-text span { color: #ffffff; font-weight: 800; }

    .search-bar { flex: 1; max-width: 380px; position: relative; }
    .search-bar input {
      width: 100%; padding: 7px 36px 7px 12px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 13px; outline: none;
      transition: border-color .2s;
    }
    .search-bar input:focus { border-color: #ffffff; }
    .search-bar input::placeholder { color: var(--text-muted); }
    .search-bar .search-icon {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      color: var(--text-muted); font-size: 14px; cursor: pointer;
    }
    .search-suggestions {
      position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 6px; overflow: hidden; display: none; z-index: 2000;
    }
    .search-suggestions.open { display: block; }
    .suggestion-item {
      padding: 8px 12px; font-size: 13px; cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: var(--bg-hover); color: #ffffff; }

    .header-tabs { display: flex; gap: 2px; margin-left: 8px; }
    .tab-btn {
      padding: 6px 14px; border-radius: 5px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1px solid transparent; transition: all .2s;
      background: none; color: var(--text-muted);
    }
    .tab-btn.active { background: #ffffff; color: #0a0a0a; border-color: #ffffff; }
    .tab-btn:not(.active):hover { border-color: var(--border); color: var(--text); }

    .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .enquire-header-btn {
      padding: 7px 18px; background: #ffffff;
      color: #0a0a0a; border: none; border-radius: 4px; font-size: 12px;
      font-weight: 700; cursor: pointer; transition: background .2s; letter-spacing: .5px;
      text-transform: uppercase;
    }
    .enquire-header-btn:hover { background: var(--accent-dark); }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .app { display: flex; height: 100vh; padding-top: 52px; }

    /* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
    .left-panel {
      width: 340px; flex-shrink: 0; background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }

    .filters-section { padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .filters-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

    .filter-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .filter-group { flex: 1; }
    .filter-group label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .filter-group select, .filter-group input[type=date], .filter-group input[type=range] {
      width: 100%; padding: 6px 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text); font-size: 12px; outline: none;
    }
    .filter-group select:focus, .filter-group input[type=date]:focus { border-color: #ffffff; }
    .range-val { font-size: 11px; color: #ffffff; float: right; }

    /* ‚îÄ‚îÄ DATA TYPE SELECTOR ‚îÄ‚îÄ */
    .datatype-section {
      padding: 12px 14px 10px; border-bottom: 1px solid var(--border);
    }
    .datatype-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px;
    }
    .datatype-card {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 5px; padding: 10px 4px 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 6px; cursor: pointer; transition: all .15s;
      color: var(--text-muted); font-size: 9px; font-weight: 600;
      text-transform: uppercase; letter-spacing: .5px; text-align: center;
      line-height: 1.2;
    }
    .datatype-card:hover {
      border-color: #555; color: var(--text); background: var(--bg-hover);
    }
    .datatype-card.active {
      border-color: #ffffff; color: #ffffff; background: rgba(255,255,255,.08);
    }
    .datatype-icon { font-size: 20px; line-height: 1; }
    .datatype-label { font-size: 9px; }

    .draw-btns { display: flex; gap: 6px; margin-top: 8px; }
    .draw-btn {
      flex: 1; padding: 7px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text-muted); font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all .2s; text-align: center;
    }
    .draw-btn:hover, .draw-btn.active { border-color: #ffffff; color: #ffffff; background: rgba(255,255,255,.08); }

    .search-btn {
      width: 100%; margin-top: 10px; padding: 9px;
      background: #ffffff; color: #0a0a0a; border: none;
      border-radius: 4px; font-size: 12px; font-weight: 700; cursor: pointer;
      transition: background .2s; text-transform: uppercase; letter-spacing: .5px;
    }
    .search-btn:hover { background: #e0e0e0; }

    /* results */
    .results-header {
      padding: 10px 14px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border); font-size: 12px;
    }
    .results-count { color: var(--text-muted); }
    .results-count strong { color: #ffffff; }
    .sort-select {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text); font-size: 11px; padding: 3px 6px; border-radius: 4px; outline: none;
    }

    .results-list { flex: 1; overflow-y: auto; padding: 8px; }
    .results-list::-webkit-scrollbar { width: 5px; }
    .results-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .result-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; margin-bottom: 8px; overflow: hidden;
      cursor: pointer; transition: border-color .2s, transform .15s;
      display: flex; flex-direction: row; height: 100px;
    }
    .result-card:hover { border-color: #ffffff; transform: translateY(-1px); }
    .result-card.selected { border-color: #ffffff; background: rgba(255,255,255,.05); }

    /* thumbnail ‚Äî left side */
    .card-thumb {
      width: 100px; flex-shrink: 0; position: relative; overflow: hidden;
      background: #0a0a0a;
    }
    .card-thumb img {
      width: 100%; height: 100%; object-fit: cover;
      display: block; opacity: .85;
    }
    .card-type {
      position: absolute; bottom: 5px; left: 5px;
      border-radius: 3px; padding: 1px 5px; font-size: 9px; font-weight: 700;
    }
    .type-optical { background: rgba(255,255,255,.90); color: #0a0a0a; }
    .type-sar     { background: rgba(160,160,160,.90); color: #0a0a0a; }

    /* body ‚Äî right side */
    .card-body {
      flex: 1; padding: 10px 12px; display: flex; flex-direction: column;
      justify-content: flex-start; gap: 2px; min-width: 0;
    }
    .card-date { font-size: 15px; font-weight: 700; color: #ffffff; margin-bottom: 2px; }
    .card-title { font-size: 13px; font-weight: 600; color: #ffffff; margin-bottom: 4px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-specs { display: flex; flex-direction: column; gap: 1px; }
    .card-spec-row { display: flex; gap: 5px; font-size: 12px; color: var(--text-muted); align-items: baseline; }
    .card-spec-row .spec-key { color: var(--text-muted); white-space: nowrap; }
    .card-spec-row .spec-val { color: var(--text-muted); font-weight: 400; white-space: nowrap; }
    .enquire-card-btn {
      padding: 3px 8px; background: none; border: 1px solid #444444;
      color: #888888; border-radius: 3px; font-size: 9px; font-weight: 600;
      cursor: pointer; transition: all .2s; text-transform: uppercase; letter-spacing: .4px;
    }
    .enquire-card-btn:hover { background: #ffffff; color: #0a0a0a; border-color: #ffffff; }

    /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
    #map { width: 100%; height: 100%; z-index: 1; }

    /* ‚îÄ‚îÄ RIGHT PANEL (detail) ‚îÄ‚îÄ */
    .detail-panel {
      position: fixed; top: 52px; right: 0; bottom: 0;
      width: 320px; background: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
      transform: translateX(100%); transition: transform .3s ease;
      z-index: 600;
    }
    .detail-panel.open { transform: translateX(0); }

    .detail-header {
      padding: 14px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .detail-header h3 { font-size: 14px; font-weight: 700; }
    .close-btn { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; }
    .close-btn:hover { color: var(--text); }

    .detail-thumb { height: 160px; position: relative; overflow: hidden; }
    .detail-thumb canvas { width: 100%; height: 100%; }

    .detail-body { padding: 14px; flex: 1; overflow-y: auto; }
    .detail-body::-webkit-scrollbar { width: 4px; }
    .detail-body::-webkit-scrollbar-thumb { background: var(--border); }

    .detail-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
    .detail-row:last-child { border-bottom: none; }
    .detail-row .key { color: var(--text-muted); }
    .detail-row .val { font-weight: 600; text-align: right; }

    .preview-bar {
      padding: 12px 14px; border-top: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 8px;
    }
    .preview-bar .price-big { font-size: 22px; font-weight: 800; color: #ffffff; }
    .preview-bar .price-note { font-size: 11px; color: var(--text-muted); }
    .enquire-detail-btn {
      width: 100%; padding: 10px; background: #ffffff; border: none;
      border-radius: 4px; color: #0a0a0a; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: background .2s; letter-spacing: .5px;
      text-transform: uppercase;
    }
    .enquire-detail-btn:hover { background: #e0e0e0; }

    .integration-btn {
      flex: 1; padding: 8px 6px; background: none;
      border: 1px solid var(--border); border-radius: 4px;
      color: var(--text-muted); font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all .2s; text-align: center;
      display: flex; align-items: center; justify-content: center; gap: 5px;
      font-family: 'Inter', sans-serif;
    }
    .integration-btn:hover { border-color: #ffffff; color: #ffffff; background: rgba(255,255,255,.06); }
    .integration-icon { font-size: 13px; }

    /* ‚îÄ‚îÄ MAP TOOLBAR (right side, on map) ‚îÄ‚îÄ */
    .leaflet-control-attribution { font-size: 12px !important; color: #fff !important; background: rgba(0,0,0,.45) !important; padding: 3px 8px !important; border-radius: 4px !important; }
    .leaflet-control-attribution a { color: #aaa !important; }

    .map-toolbar {
      position: absolute; top: 10px; right: 10px; z-index: 500;
      display: flex; flex-direction: column; gap: 6px; align-items: flex-end;
    }

    /* Draw tools group */
    .toolbar-group {
      background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,.4);
      display: flex; flex-direction: column;
    }
    .toolbar-btn {
      width: 36px; height: 36px; background: none; border: none;
      border-bottom: 1px solid var(--border); color: var(--text-muted);
      font-size: 16px; cursor: pointer; display: flex; align-items: center;
      justify-content: center; transition: all .15s;
    }
    .toolbar-btn:last-child { border-bottom: none; }
    .toolbar-btn:hover { background: var(--bg-hover); color: #ffffff; }
    .toolbar-btn.active { background: rgba(255,255,255,.15); color: #ffffff; }
    .toolbar-btn[title]:hover::after {
      content: attr(title);
      position: absolute; right: 44px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 5px; padding: 4px 8px; font-size: 11px;
      color: var(--text); white-space: nowrap; pointer-events: none;
    }

    /* Layer switcher dropdown */
    .layer-switcher {
      background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,.4);
      display: flex; flex-direction: column;
    }
    .layer-switcher-title {
      font-size: 9px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 1px;
      padding: 6px 10px 4px; border-bottom: 1px solid var(--border);
    }
    .layer-btn {
      padding: 6px 12px; border: none; background: none; color: var(--text-muted);
      font-size: 11px; font-weight: 600; cursor: pointer;
      text-align: left; transition: all .15s; white-space: nowrap;
      border-bottom: 1px solid var(--border);
    }
    .layer-btn:last-child { border-bottom: none; }
    .layer-btn.active { background: rgba(255,255,255,.10); color: #ffffff; }
    .layer-btn:not(.active):hover { background: var(--bg-hover); color: var(--text); }

    /* Location quick-jump */
    .map-tools {
      position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
      z-index: 500; display: flex; gap: 6px;
    }
    .map-tool-btn {
      padding: 6px 14px; background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: 20px; color: var(--text); font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all .2s;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
    }
    .map-tool-btn:hover { border-color: #ffffff; color: #ffffff; background: rgba(255,255,255,.08); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
      background: #ffffff; border: 1px solid #333333; border-radius: 4px;
      padding: 10px 20px; font-size: 12px; color: #0a0a0a; font-weight: 600;
      z-index: 9999; transition: transform .3s ease; pointer-events: none;
      text-transform: uppercase; letter-spacing: .3px;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ ENQUIRE MODAL ‚îÄ‚îÄ */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      z-index: 5000; display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity .25s ease;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: 12px; width: 460px; max-width: 95vw;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      transform: translateY(20px); transition: transform .25s ease;
    }
    .modal-backdrop.open .modal { transform: translateY(0); }
    .modal-header {
      padding: 18px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h2 { font-size: 16px; font-weight: 700; }
    .modal-header .modal-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; }
    .modal-context {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 7px; padding: 10px 12px; font-size: 12px;
    }
    .modal-context-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .modal-context-info { display: flex; flex-wrap: wrap; gap: 6px; }
    .modal-tag {
      background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.2);
      border-radius: 3px; padding: 2px 8px; font-size: 11px; color: #dddddd;
    }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 11px; color: var(--text-muted); font-weight: 600; }
    .form-group input, .form-group textarea, .form-group select {
      padding: 8px 10px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 13px; outline: none;
      transition: border-color .2s; font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #ffffff; }
    .form-group input::placeholder, .form-group textarea::placeholder { color: var(--text-muted); }
    .form-group textarea { resize: vertical; min-height: 72px; }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }
    .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
    .btn-cancel {
      padding: 9px 18px; background: none; border: 1px solid var(--border);
      border-radius: 7px; color: var(--text-muted); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all .2s;
    }
    .btn-cancel:hover { border-color: var(--text-muted); color: var(--text); }
    .btn-submit {
      padding: 9px 24px; background: #ffffff; border: none;
      border-radius: 4px; color: #0a0a0a; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: background .2s; text-transform: uppercase; letter-spacing: .5px;
    }
    .btn-submit:hover { background: #e0e0e0; }

    /* spinner */
    .spinner {
      width: 36px; height: 36px; border: 3px solid var(--border);
      border-top-color: #ffffff; border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* empty state */
    .empty-state {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 12px; color: var(--text-muted);
      padding: 20px; text-align: center;
    }
    .empty-icon { font-size: 40px; }
    .empty-state h4 { font-size: 14px; color: var(--text); }
    .empty-state p { font-size: 12px; line-height: 1.5; }

    input[type=range] { accent-color: #ffffff; }
    input[type=date]::-webkit-calendar-picker-indicator { filter: invert(.5); }

    /* ‚îÄ‚îÄ Footprint hover tooltip ‚îÄ‚îÄ */
    .footprint-tooltip {
      background: #111111 !important;
      border: 1px solid #3a3a3a !important;
      border-radius: 7px !important;
      box-shadow: 0 6px 20px rgba(0,0,0,.7) !important;
      color: #f0f0f0 !important;
      padding: 8px 12px !important;
    }
    .footprint-tooltip::before { display: none !important; }
    .leaflet-tooltip-top.footprint-tooltip::before,
    .leaflet-tooltip-bottom.footprint-tooltip::before,
    .leaflet-tooltip-left.footprint-tooltip::before,
    .leaflet-tooltip-right.footprint-tooltip::before { display: none !important; }

    /* ‚îÄ‚îÄ AOI Metrics Tooltip ‚îÄ‚îÄ */
    .aoi-tooltip {
      position: absolute; z-index: 800; pointer-events: none;
      background: #111111; border: 1px solid #2e2e2e;
      border-radius: 8px; padding: 10px 13px;
      box-shadow: 0 4px 20px rgba(0,0,0,.7);
      font-family: 'Inter', sans-serif; font-size: 11px;
      min-width: 195px;
      top: 10px; left: 10px;
    }
    .aoi-tooltip-title {
      font-size: 9px; font-weight: 700; color: #555555;
      text-transform: uppercase; letter-spacing: 1.2px;
      margin-bottom: 7px;
    }
    .aoi-tooltip-divider {
      border-top: 1px solid #2a2a2a; margin: 4px 0;
    }
    .aoi-tooltip-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 2px 0; gap: 16px;
    }
    .aoi-tooltip-key { color: #666666; font-weight: 500; white-space: nowrap; }
    .aoi-tooltip-val { color: #ffffff; font-weight: 600; text-align: right; white-space: nowrap; }

    /* ‚îÄ‚îÄ Edge length labels on map ‚îÄ‚îÄ */
    .edge-label {
      background: none; border: none; pointer-events: none;
    }
    .edge-label span {
      display: inline-block;
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 3px;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      font-size: 10px;
      font-weight: 600;
      padding: 1px 5px;
      white-space: nowrap;
      transform: translate(-50%, -50%);
    }

    /* ‚îÄ‚îÄ Leaflet Draw edit handles ‚îÄ‚îÄ */
    .leaflet-editing-icon {
      width: 10px !important; height: 10px !important;
      margin-left: -5px !important; margin-top: -5px !important;
      border-radius: 0 !important;
      background: #ffffff !important;
      border: 2px solid #0a0a0a !important;
      box-shadow: 0 1px 4px rgba(0,0,0,.5) !important;
    }
    .leaflet-touch .leaflet-editing-icon {
      width: 14px !important; height: 14px !important;
      margin-left: -7px !important; margin-top: -7px !important;
    }

    @media (max-width: 900px) {
      .left-panel { width: 280px; }
      .detail-panel { width: 260px; }
    }

    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
    @media (max-width: 767px) {
      header {
        padding: 0 12px; gap: 10px; height: 48px;
      }
      .logo-text span { font-size: 12px; letter-spacing: 1px; }
      .search-bar { max-width: none; flex: 1; }
      .header-tabs { display: none; }
      .enquire-header-btn { display: none; }

      .app { flex-direction: column; padding-top: 48px; }

      /* Map fills screen */
      .app > div:last-child { flex: 1; min-height: 0; }

      /* Left panel ‚Üí bottom sheet */
      .left-panel {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        width: 100% !important;
        height: auto;
        max-height: 75vh;
        border-right: none;
        border-top: 1px solid var(--border);
        border-radius: 16px 16px 0 0;
        z-index: 900;
        transform: translateY(calc(100% - 48px));
        transition: transform .35s cubic-bezier(.4,0,.2,1);
        overflow: hidden;
      }
      .left-panel.sheet-open {
        transform: translateY(0);
      }

      /* Drag handle */
      .sheet-handle {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
        background: var(--bg-panel);
        border-bottom: 1px solid var(--border);
        padding-top: 8px;
      }
      .sheet-handle-bar {
        width: 36px; height: 4px;
        background: #444; border-radius: 2px;
        margin-bottom: 8px; cursor: pointer;
      }

      /* Tabs inside handle */
      .sheet-tabs {
        display: flex; width: 100%;
        border-top: 1px solid var(--border);
      }
      .sheet-tab {
        flex: 1; padding: 10px;
        font-size: 12px; font-weight: 700;
        background: none; border: none;
        color: var(--text-muted);
        cursor: pointer; text-transform: uppercase;
        letter-spacing: .5px;
        border-bottom: 2px solid transparent;
        transition: all .15s;
      }
      .sheet-tab.active {
        color: #fff;
        border-bottom-color: #fff;
      }

      /* Tab content scrollable */
      .sheet-tab-content {
        overflow-y: auto;
        max-height: calc(75vh - 80px);
      }
      .results-section { max-height: none; overflow-y: visible; }

      /* Detail panel full screen on mobile */
      .detail-panel {
        position: fixed !important;
        inset: 48px 0 0 0 !important;
        width: 100% !important;
        z-index: 950;
        border-left: none;
      }

      /* FAB search button */
      .mobile-search-fab {
        display: flex;
        position: fixed;
        bottom: 60px; left: 50%; transform: translateX(-50%);
        z-index: 910;
        background: #fff; color: #000;
        border: none; border-radius: 24px;
        padding: 10px 24px;
        font-size: 13px; font-weight: 700;
        letter-spacing: .5px; text-transform: uppercase;
        box-shadow: 0 4px 16px rgba(0,0,0,.5);
        cursor: pointer;
        transition: opacity .2s;
      }
      .mobile-search-fab.hidden { opacity: 0; pointer-events: none; }
    }

    @media (min-width: 768px) {
      .sheet-handle { display: none; }
      .mobile-search-fab { display: none; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-text" style="display:flex;flex-direction:column;line-height:1.1;">
      <span style="font-size:14px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#fff;">Geospatial Explorer</span>
    </div>
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search location‚Ä¶" autocomplete="off" />
    <span class="search-icon">‚åï</span>
    <div class="search-suggestions" id="searchSuggestions"></div>
  </div>

  <div class="header-right">
  </div>
</header>

<!-- MAIN -->
<div class="app">

  <!-- LEFT PANEL -->
  <div class="left-panel" id="leftPanel">
    <!-- MOBILE HANDLE + TABS -->
    <div class="sheet-handle" id="sheetHandle">
      <div class="sheet-handle-bar" onclick="toggleSheet()"></div>
      <div class="sheet-tabs" id="sheetTabs">
        <button class="sheet-tab active" id="tabFilters" onclick="switchSheetTab('filters')">Filters</button>
        <button class="sheet-tab" id="tabResults" onclick="switchSheetTab('results')">Results</button>
      </div>
    </div>

    <!-- FILTERS TAB CONTENT -->
    <div id="sheetFiltersContent" class="sheet-tab-content">
    <!-- DATA TYPE SELECTOR -->
    <div class="datatype-section">
      <div class="filters-title">Data Type</div>
      <div class="datatype-grid">
        <button class="datatype-card active" data-type="all" onclick="selectDataType('all', this)">
          <span class="datatype-label">All</span>
        </button>
        <button class="datatype-card" data-type="optical_satellite" onclick="selectDataType('optical_satellite', this)">
          <span class="datatype-label">Optical</span>
        </button>
        <button class="datatype-card" data-type="sar" onclick="selectDataType('sar', this)">
          <span class="datatype-label">SAR</span>
        </button>
        <button class="datatype-card" data-type="optical_aerial" onclick="selectDataType('optical_aerial', this)">
          <span class="datatype-label">Aerial</span>
        </button>
        <button class="datatype-card" data-type="elevation" onclick="selectDataType('elevation', this)">
          <span class="datatype-label">Elevation</span>
        </button>
        <button class="datatype-card" data-type="hyperspectral" onclick="selectDataType('hyperspectral', this)">
          <span class="datatype-label">Hyperspectral</span>
        </button>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-title">Search Filters</div>



      <div class="filter-row">
        <div class="filter-group">
          <label>Date From</label>
          <input type="date" id="dateFrom" value="2025-01-01" />
        </div>
        <div class="filter-group">
          <label>Date To</label>
          <input type="date" id="dateTo" value="2026-12-31" />
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label>Resolution</label>
          <select id="resolution">
            <option value="all">Any</option>
            <option value="high">High (&lt;1 m)</option>
            <option value="medium">Medium (1‚Äì3 m)</option>
            <option value="low">Low (&gt;3 m)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Provider</label>
          <select id="provider">
            <option value="all">All Providers</option>
            <optgroup label="Optical">
              <option value="vantor">Vantor</option>
              <option value="maxar">Maxar</option>
              <option value="airbus">Airbus</option>
              <option value="planet">Planet Labs</option>
              <option value="satellogic">Satellogic</option>
              <option value="vexcel">Vexcel Imaging</option>
            </optgroup>
            <optgroup label="SAR">
              <option value="iceye">ICEYE</option>
              <option value="capella">Capella Space</option>
              <option value="umbra">Umbra</option>
            </optgroup>
            <optgroup label="Open Data">
              <option value="sentinel">Sentinel (ESA)</option>
              <option value="landsat">Landsat (USGS)</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="filter-group" style="margin-bottom:8px">
        <label>Max Cloud Cover: <span class="range-val" id="cloudVal">30%</span></label>
        <input type="range" id="cloudCover" min="0" max="100" value="30"
               oninput="document.getElementById('cloudVal').textContent=this.value+'%'" />
      </div>

      <div class="filter-group" style="margin-bottom:8px">
        <label>Min Coverage: <span class="range-val" id="coverageVal">80%</span></label>
        <input type="range" id="coverage" min="0" max="100" value="80"
               oninput="document.getElementById('coverageVal').textContent=this.value+'%'" />
      </div>

      <button class="search-btn" onclick="runSearch()">üîç Search Imagery</button>
    </div>

    </div><!-- /sheetFiltersContent -->

    <!-- RESULTS TAB CONTENT -->
    <div id="sheetResultsContent" class="sheet-tab-content">
    <div class="results-header">
      <div class="results-count">Found: <strong id="resultCount">0</strong></div>
      <select class="sort-select" id="sortSelect" onchange="sortResults()">
        <option value="date">Date ‚Üì</option>

        <option value="cloud">Cloud Cover</option>
        <option value="res">Resolution</option>
      </select>
    </div>

    <div id="resultsList" class="results-list">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">‚óé</div>
        <h4>Start your search</h4>
        <p>Draw an area of interest on the map or set filter parameters, then click "Search Imagery".</p>
      </div>
    </div>
    </div><!-- /sheetResultsContent -->
  </div>

  <!-- MAP -->
  <div style="position:relative;flex:1;display:flex;flex-direction:column;">
    <div id="map" style="flex:1;min-height:0;"></div>

    <!-- RIGHT TOOLBAR on map -->
    <div class="map-toolbar">

      <!-- Zoom tools -->
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="map.zoomIn()" title="Zoom In">+</button>
        <button class="toolbar-btn" onclick="map.zoomOut()" title="Zoom Out">‚àí</button>
      </div>

      <!-- Draw tools -->
      <div class="toolbar-group">
        <button class="toolbar-btn" id="btnRect" onclick="activateDraw('rect')" title="Draw Rectangle">‚ñ≠</button>
        <button class="toolbar-btn" id="btnPoly" onclick="activateDraw('poly')" title="Draw Polygon">‚¨°</button>
        <button class="toolbar-btn" id="btnClear" onclick="clearAOI()" title="Clear AOI">‚úï</button>
      </div>


      <!-- Layer switcher as single icon button with tooltip -->
      <div class="toolbar-group" style="position:relative;">
        <button class="toolbar-btn" id="layerToggleBtn" onclick="toggleLayerMenu()" title="Switch Base Layer">‚äû</button>
      </div>
      <div class="layer-switcher" id="layerSwitcher" style="display:none;">
        <div class="layer-switcher-title">Base Layer</div>
        <button class="layer-btn active" id="lyrCesium" onclick="switchLayer('cesium')">Cesium Ion Aerial</button>
        <button class="layer-btn" id="lyrEsri" onclick="switchLayer('esri')">ESRI Satellite</button>
        <button class="layer-btn" id="lyrSat" onclick="switchLayer('satellite')">Google Satellite</button>
        <button class="layer-btn" id="lyrHybrid" onclick="switchLayer('hybrid')">Google Hybrid</button>
        <button class="layer-btn" id="lyrDark" onclick="switchLayer('dark')">Dark</button>
        <button class="layer-btn" id="lyrOSM" onclick="switchLayer('osm')">OpenStreetMap</button>
      </div>

    </div>

  </div>

  <!-- RIGHT DETAIL PANEL -->
  <div class="detail-panel" id="detailPanel">
    <div class="detail-header">
      <div>
        <h3 id="detailTitle">Image Details</h3>
      </div>
      <button class="close-btn" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="detail-thumb">
      <img id="detailImg" src="" alt="" style="width:100%;height:100%;object-fit:cover;display:block;" />
    </div>
    <div class="detail-body" id="detailBody"></div>
    <div class="preview-bar">
      <button class="enquire-detail-btn" onclick="openEnquire(currentDetail)">Enquire Now</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ENQUIRE MODAL -->
<div class="modal-backdrop" id="modalBackdrop" onclick="handleBackdropClick(event)">
  <div class="modal" id="enquireModal">
    <div class="modal-header">
      <div>
        <h2>Enquire Now</h2>
        <div class="modal-subtitle">Our team will get back to you within 1 business day</div>
      </div>
      <button class="close-btn" onclick="closeEnquire()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-context" id="modalContext" style="display:none">
        <div class="modal-context-label">Selected Image</div>
        <div class="modal-context-info" id="modalContextInfo"></div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" id="fName" placeholder="John" />
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" id="lName" placeholder="Smith" />
        </div>
      </div>
      <div class="form-group">
        <label>Work Email *</label>
        <input type="email" id="fEmail" placeholder="john.smith@company.com" />
      </div>
      <div class="form-group">
        <label>Organisation</label>
        <input type="text" id="fOrg" placeholder="Company name" />
      </div>
      <div class="form-group">
        <label>Use Case</label>
        <select id="fUseCase">
          <option value="">Select a use case‚Ä¶</option>
          <option>Agriculture & Land Use</option>
          <option>Infrastructure Monitoring</option>
          <option>Disaster Response</option>
          <option>Urban Planning</option>
          <option>Defence & Security</option>
          <option>Environmental Monitoring</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Message</label>
        <textarea id="fMessage" placeholder="Tell us more about your requirements‚Ä¶"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeEnquire()">Cancel</button>
      <button class="btn-submit" onclick="submitEnquiry()">Send Enquiry ‚Üí</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>
<script>
// ‚îÄ‚îÄ GOOGLE MAPS API KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Insert your key here: https://console.cloud.google.com ‚Üí Maps JavaScript API
const GOOGLE_API_KEY = 'INSERT_YOUR_KEY_HERE';

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = L.map('map', { zoomControl: false, attributionControl: true }).setView([48, 25], 4);
map.attributionControl.setPrefix('Developed by Denys Antonov, E&amp;V');

const tileLayers = {
  esri: L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19, attribution: 'Tiles ¬© Esri' }
  ),
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd', maxZoom: 19
  }),
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }),
  satellite: null,
  hybrid: null,
  cesium: null,
};

// ‚îÄ‚îÄ CESIUM ION ¬∑ Bing Aerial (lazy ‚Äî created only on first click) ‚îÄ‚îÄ
const BING_SUBDOMAINS = ['t0','t1','t2','t3'];

function tileToQuadkey(x, y, z) {
  let q = '';
  for (let i = z; i > 0; i--) {
    let d = 0, m = 1 << (i - 1);
    if (x & m) d |= 1;
    if (y & m) d |= 2;
    q += d;
  }
  return q;
}

function createCesiumLayer() {
  const BingAerialLayer = L.TileLayer.extend({
    getTileUrl(coords) {
      const qk  = tileToQuadkey(coords.x, coords.y, coords.z);
      const sub = BING_SUBDOMAINS[(coords.x + coords.y) % BING_SUBDOMAINS.length];
      return `https://ecn.${sub}.tiles.virtualearth.net/tiles/a${qk}.jpeg?g=13816&mkt=en-US`;
    }
  });
  return new BingAerialLayer('', {
    attribution: '',
    maxZoom: 20, minZoom: 1
  });
}

tileLayers.cesium = createCesiumLayer();
let activeLayerKey = 'cesium';
tileLayers.cesium.addTo(map);

// ESRI labels overlay (city names, roads ‚Äî transparent layer on top)
const esriLabels = L.tileLayer(
  'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 19, opacity: 1, pane: 'overlayPane' }
);
esriLabels.addTo(map);

function loadGoogleMapsAPI() {
  if (GOOGLE_API_KEY === 'INSERT_YOUR_KEY_HERE') {
    document.getElementById('lyrSat').title = 'Google Maps API key required';
    document.getElementById('lyrHybrid').title = 'Google Maps API key required';
    document.getElementById('lyrSat').style.opacity = '0.4';
    document.getElementById('lyrHybrid').style.opacity = '0.4';
    return;
  }
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&callback=onGoogleMapsReady`;
  script.async = true; script.defer = true;
  document.head.appendChild(script);
}

window.onGoogleMapsReady = function () {
  tileLayers.satellite = L.gridLayer.googleMutant({ type: 'satellite', maxZoom: 21 });
  tileLayers.hybrid    = L.gridLayer.googleMutant({ type: 'hybrid',    maxZoom: 21 });
};

loadGoogleMapsAPI();

function toggleLayerMenu() {
  const menu = document.getElementById('layerSwitcher');
  menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
}

document.addEventListener('click', e => {
  if (!e.target.closest('.map-toolbar')) {
    document.getElementById('layerSwitcher').style.display = 'none';
  }
});

function switchLayer(key) {
  if (key === activeLayerKey) return;
  if ((key === 'satellite' || key === 'hybrid') && !tileLayers[key]) {
    showToast('Google Maps API key required ‚Äî see GOOGLE_API_KEY in the source');
    return;
  }
  if (key === 'cesium' && !tileLayers[key]) {
    tileLayers.cesium = createCesiumLayer();
  }
  if (tileLayers[activeLayerKey]) map.removeLayer(tileLayers[activeLayerKey]);
  tileLayers[key].addTo(map);
  activeLayerKey = key;
  ['lyrEsri','lyrCesium','lyrSat','lyrHybrid','lyrDark','lyrOSM'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  const btnMap = { esri:'lyrEsri', cesium:'lyrCesium', satellite:'lyrSat', hybrid:'lyrHybrid', dark:'lyrDark', osm:'lyrOSM' };
  document.getElementById(btnMap[key]).classList.add('active');
  document.getElementById('layerSwitcher').style.display = 'none';
}

L.control.zoom({ position: 'topright' }).addTo(map);

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const drawnItems = new L.FeatureGroup().addTo(map);
let drawHandler = null;
let currentAOI = null;

// ‚îÄ‚îÄ GEOCODING SEARCH (Nominatim) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const searchInput = document.getElementById('searchInput');
const suggBox     = document.getElementById('searchSuggestions');
let _searchTimer  = null;
let _lastResults  = [];

function formatSuggestion(item) {
  const parts = item.display_name.split(', ');
  // Show first 3 parts for brevity (e.g. "Dublin, Leinster, Ireland")
  return parts.slice(0, 3).join(', ');
}

async function geocodeQuery(q) {
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=6&addressdetails=1`;
  const res  = await fetch(url, { headers: { 'Accept-Language': 'en' } });
  return await res.json();
}

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  if (q.length < 2) { suggBox.classList.remove('open'); _lastResults = []; return; }
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(async () => {
    try {
      const results = await geocodeQuery(q);
      _lastResults = results;
      if (!results.length) { suggBox.classList.remove('open'); return; }
      suggBox.innerHTML = results.map((r, i) =>
        `<div class="suggestion-item" onclick="selectGeoResult(${i})">${formatSuggestion(r)}</div>`
      ).join('');
      suggBox.classList.add('open');
    } catch (e) { suggBox.classList.remove('open'); }
  }, 300);
});

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    if (_lastResults.length) selectGeoResult(0);
    else geocodeQuery(searchInput.value.trim()).then(r => { if (r.length) { _lastResults = r; selectGeoResult(0); }});
  }
  if (e.key === 'Escape') suggBox.classList.remove('open');
});

document.addEventListener('click', e => {
  if (!e.target.closest('.search-bar')) suggBox.classList.remove('open');
});

function selectGeoResult(idx) {
  const r = _lastResults[idx];
  if (!r) return;
  searchInput.value = formatSuggestion(r);
  suggBox.classList.remove('open');
  const lat = parseFloat(r.lat);
  const lon = parseFloat(r.lon);
  // Determine zoom from result type
  const typeZoom = { city: 11, town: 12, village: 13, suburb: 13, county: 10, state: 8, country: 6 };
  const zoom = typeZoom[r.addresstype] || typeZoom[r.type] || 11;
  map.flyTo([lat, lon], zoom, { duration: 1.2 });
  setTimeout(runSearch, 1400);
}

// ‚îÄ‚îÄ DATA TYPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeDataType = 'all';

function selectDataType(type, el) {
  activeDataType = type;
  document.querySelectorAll('.datatype-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  runSearch();
}

// ‚îÄ‚îÄ ARCHIVE / TASKING MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeMode = 'archive';

function setMode(mode) {
  activeMode = mode;
  const archBtn = document.getElementById('modeArchive');
  const taskBtn = document.getElementById('modeTasking');
  if (mode === 'archive') {
    archBtn.style.background = 'rgba(255,255,255,.10)'; archBtn.style.color = '#fff';
    taskBtn.style.background = 'none'; taskBtn.style.color = 'var(--text-muted)';
    showToast('Archive mode ‚Äî searching existing imagery');
  } else {
    taskBtn.style.background = 'rgba(255,255,255,.10)'; taskBtn.style.color = '#fff';
    archBtn.style.background = 'none'; archBtn.style.color = 'var(--text-muted)';
    showToast('Tasking mode ‚Äî request future satellite capture');
  }
  runSearch();
}

// ‚îÄ‚îÄ BENTLEY INTEGRATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openInITwin() {
  if (!currentDetail) return;
  showToast('Opening in Bentley iTwin‚Ä¶ (integration pending API key)');
}
function openInCesium() {
  if (!currentDetail) return;
  showToast('Opening in Cesium Ion‚Ä¶ (integration pending API key)');
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let editDebounce = null;

const SHAPE_OPTS = {
  color: '#ffffff', weight: 2,
  fillColor: '#ffffff', fillOpacity: 0.06
};

function activateDraw(mode) {
  // cancel any active draw
  if (drawHandler) { try { drawHandler.disable(); } catch(e){} drawHandler = null; }
  clearAOI();
  document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));

  if (mode === 'rect') {
    document.getElementById('btnRect').classList.add('active');
    drawHandler = new L.Draw.Rectangle(map, { shapeOptions: SHAPE_OPTS });
  } else {
    document.getElementById('btnPoly').classList.add('active');
    drawHandler = new L.Draw.Polygon(map, {
      shapeOptions: SHAPE_OPTS,
      showLength: true,
      allowIntersection: false
    });
  }
  drawHandler.enable();
  showToast(mode === 'rect' ? 'Click and drag to draw a rectangle' : 'Click to place points, double-click to finish');
}

map.on(L.Draw.Event.CREATED, e => {
  clearAOI();
  currentAOI = e.layer;
  drawnItems.addLayer(currentAOI);
  document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
  drawHandler = null;

  // Enable vertex editing immediately
  enableEditing(currentAOI);
  runSearch();
});

// ‚îÄ‚îÄ AOI METRICS TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let aoiTooltipEl = null;
let edgeLabelMarkers = [];

function createAoiTooltip() {
  if (!aoiTooltipEl) {
    aoiTooltipEl = document.createElement('div');
    aoiTooltipEl.className = 'aoi-tooltip';
    aoiTooltipEl.style.display = 'none';
    document.getElementById('map').appendChild(aoiTooltipEl);
  }
  return aoiTooltipEl;
}

function hideAoiTooltip() {
  if (aoiTooltipEl) aoiTooltipEl.style.display = 'none';
  clearEdgeLabels();
}

// Haversine distance in metres between two LatLng points
function haversineDist(a, b) {
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLng = Math.sin(dLng / 2);
  const h = sinDLat * sinDLat +
    Math.cos(a.lat * Math.PI / 180) * Math.cos(b.lat * Math.PI / 180) * sinDLng * sinDLng;
  return 2 * R * Math.asin(Math.sqrt(h));
}

// Bearing between two points in degrees (0‚Äì360)
function bearing(a, b) {
  const lat1 = a.lat * Math.PI / 180, lat2 = b.lat * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const x = Math.sin(dLng) * Math.cos(lat2);
  const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
  return ((Math.atan2(x, y) * 180 / Math.PI) + 360) % 360;
}

// Deflection angle between two consecutive segments (exterior turn angle)
function deflection(a, b, c) {
  const b1 = bearing(a, b);
  const b2 = bearing(b, c);
  let delta = b2 - b1;
  if (delta > 180) delta -= 360;
  if (delta < -180) delta += 360;
  return Math.abs(delta);
}

// Shoelace formula for polygon area in m¬≤
function polyArea(latlngs) {
  const pts = latlngs;
  const n = pts.length;
  if (n < 3) return 0;
  const R = 6371000;
  let area = 0;
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n;
    const lat1 = pts[i].lat * Math.PI / 180;
    const lat2 = pts[j].lat * Math.PI / 180;
    const dLng  = (pts[j].lng - pts[i].lng) * Math.PI / 180;
    area += dLng * (2 + Math.sin(lat1) + Math.sin(lat2));
  }
  return Math.abs(area * R * R / 2);
}

function formatDist(m) {
  return m >= 1000 ? (m / 1000).toFixed(2) + ' km' : Math.round(m) + ' m';
}
function formatArea(m2) {
  return m2 >= 1e6 ? (m2 / 1e6).toFixed(2) + ' km¬≤' : Math.round(m2) + ' m¬≤';
}

function clearEdgeLabels() {
  edgeLabelMarkers.forEach(m => map.removeLayer(m));
  edgeLabelMarkers = [];
}

function midLatLng(a, b) {
  return L.latLng((a.lat + b.lat) / 2, (a.lng + b.lng) / 2);
}

function renderEdgeLabels(latlngs) {
  clearEdgeLabels();
  const closed = [...latlngs, latlngs[0]];
  for (let i = 0; i < closed.length - 1; i++) {
    const a = closed[i], b = closed[i + 1];
    const dist = haversineDist(a, b);
    const mid = midLatLng(a, b);
    const marker = L.marker(mid, {
      icon: L.divIcon({
        className: 'edge-label',
        html: `<span>${formatDist(dist)}</span>`,
        iconAnchor: [0, 0],
      }),
      interactive: false,
      zIndexOffset: 900,
    }).addTo(map);
    edgeLabelMarkers.push(marker);
  }
}

function updateAoiTooltip(layer) {
  const el = createAoiTooltip();
  let latlngs = [];

  if (layer.getLatLngs) {
    const raw = layer.getLatLngs();
    latlngs = Array.isArray(raw[0]) ? raw[0] : raw;
  }
  if (latlngs.length < 2) { hideAoiTooltip(); clearEdgeLabels(); return; }

  const closed = [...latlngs, latlngs[0]];

  // Perimeter
  let perimeter = 0;
  for (let i = 0; i < closed.length - 1; i++) {
    perimeter += haversineDist(closed[i], closed[i + 1]);
  }

  // Area
  const area = polyArea(latlngs);

  // Centroid
  const latC = latlngs.reduce((s, p) => s + p.lat, 0) / latlngs.length;
  const lngC = latlngs.reduce((s, p) => s + p.lng, 0) / latlngs.length;

  // W √ó H (bounding box)
  const lats = latlngs.map(p => p.lat), lngs = latlngs.map(p => p.lng);
  const minLat = Math.min(...lats), maxLat = Math.max(...lats);
  const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);
  const W = haversineDist({ lat: minLat, lng: minLng }, { lat: minLat, lng: maxLng });
  const H = haversineDist({ lat: minLat, lng: minLng }, { lat: maxLat, lng: minLng });

  // Vertices count
  const vCount = latlngs.length;

  // Last deflection angle
  let deflAngle = null;
  if (latlngs.length >= 3) {
    const n = latlngs.length;
    deflAngle = deflection(latlngs[n - 3] || latlngs[0], latlngs[n - 2], latlngs[n - 1]);
  }

  el.innerHTML = `
    <div class="aoi-tooltip-title">AOI Metrics</div>
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">Area</span>
      <span class="aoi-tooltip-val">${formatArea(area)}</span>
    </div>
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">Perimeter</span>
      <span class="aoi-tooltip-val">${formatDist(perimeter)}</span>
    </div>
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">W √ó H</span>
      <span class="aoi-tooltip-val">${formatDist(W)} √ó ${formatDist(H)}</span>
    </div>
    ${deflAngle !== null ? `
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">Deflection</span>
      <span class="aoi-tooltip-val">${deflAngle.toFixed(1)}¬∞</span>
    </div>` : ''}
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">Vertices</span>
      <span class="aoi-tooltip-val">${vCount}</span>
    </div>
    <div class="aoi-tooltip-divider"></div>
    <div class="aoi-tooltip-row">
      <span class="aoi-tooltip-key">Center</span>
      <span class="aoi-tooltip-val">${latC.toFixed(5)}, ${lngC.toFixed(5)}</span>
    </div>
  `;

  el.style.display = 'block';

  // Render per-edge length labels on the map
  renderEdgeLabels(latlngs);
}

function enableEditing(layer) {
  if (!layer) return;
  if (layer.editing) {
    layer.editing.enable();
    layer.off('edit').on('edit', () => {
      updateAoiTooltip(layer);
      clearTimeout(editDebounce);
      editDebounce = setTimeout(() => runSearch(), 400);
    });
  }
  // Show tooltip immediately on enable
  updateAoiTooltip(layer);
  // Also allow dragging the whole shape
  if (layer.dragging) layer.dragging.enable();
}

// Click on AOI to re-enable editing if it was somehow disabled
drawnItems.on('click', e => {
  L.DomEvent.stopPropagation(e);
  enableEditing(e.layer);
});

function clearAOI() {
  if (currentAOI) {
    try { if (currentAOI.editing) currentAOI.editing.disable(); } catch(e){}
    currentAOI = null;
  }
  drawnItems.clearLayers();
  hideAoiTooltip();
}

// Update tooltip while drawing in real-time
map.on('draw:drawvertex', e => {
  const layers = e.layers;
  if (layers) {
    layers.eachLayer(l => updateAoiTooltip(l));
  }
});

// ‚îÄ‚îÄ SATELLITE IMAGE POOL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Real satellite/aerial imagery from public sources (NASA, ESA, USGS, Wikimedia)
const SAT_IMAGES = {
  optical_satellite: [
    'https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Fujisan_from_ISS.jpg/640px-Fujisan_from_ISS.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/PNG_deforestation_2.jpg/640px-PNG_deforestation_2.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Camponotus_flavomarginatus_ant.jpg/320px-Camponotus_flavomarginatus_ant.jpg',
    'https://eoimages.gsfc.nasa.gov/images/imagerecords/73000/73751/world.topo.bathy.200407.3x5400x2700.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/The_Earth_seen_from_Apollo_17.jpg/320px-The_Earth_seen_from_Apollo_17.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Dubai_ISS.jpg/640px-Dubai_ISS.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Earth_from_Space.jpg/640px-Earth_from_Space.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b5/–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã.jpg/640px-–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã.jpg',
  ],
  optical_aerial: [
    'https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Lion_waiting_in_Namibia.jpg/320px-Lion_waiting_in_Namibia.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Kota_Kinabalu_aerial_2012.jpg/640px-Kota_Kinabalu_aerial_2012.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Manhattan_from_the_Top_of_the_Rock.jpg/640px-Manhattan_from_the_Top_of_the_Rock.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Lamma_Island_from_the_air.jpg/640px-Lamma_Island_from_the_air.jpg',
  ],
  elevation: [
    'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Blue_Marble_2002.png/640px-Blue_Marble_2002.png',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/WorldDEM_DTM_visual.jpg/640px-WorldDEM_DTM_visual.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Lidar_derived_digital_terrain_model.jpg/640px-Lidar_derived_digital_terrain_model.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Sentinel_3B_elevation_model.jpg/640px-Sentinel_3B_elevation_model.jpg',
  ],
  sar: [
    'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/SAR_ERS_flooding_Germany.jpg/640px-SAR_ERS_flooding_Germany.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/SAR_image_of_Paris.jpg/640px-SAR_image_of_Paris.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Sentinel-1_SAR_image.jpg/640px-Sentinel-1_SAR_image.jpg',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/ERS2_SAR_etna.jpg/640px-ERS2_SAR_etna.jpg',
  ],
  basemap: [
    'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/World_Map_1689.JPG/640px-World_Map_1689.JPG',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/World_map_-_low_resolution.svg/640px-World_map_-_low_resolution.svg.png',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Blue_Marble_2002.png/640px-Blue_Marble_2002.png',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/NASA_Visible_Earth_-_The_Blue_Marble_-_Land_Surface,_Ocean_Color_and_Sea_Ice_-_Aus.jpg/640px-NASA_Visible_Earth_-_The_Blue_Marble_-_Land_Surface,_Ocean_Color_and_Sea_Ice_-_Aus.jpg',
  ],
};

// Curated Unsplash satellite-style images (reliable, free, no auth needed)
const THUMB_POOL = [
  // satellite city/land views
  'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1614730321146-b6fa6a46bcb4?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1542401886-65d6c61db217?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1523978591478-c753949ff840?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1416339306562-f3d12fefd36f?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1489824904134-891ab64532f1?w=200&h=200&fit=crop',
  // aerial/urban
  'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1444723121867-7a241cacace9?w=200&h=200&fit=crop',
  'https://images.unsplash.com/photo-1522083165195-3424ed129620?w=200&h=200&fit=crop',
];

function getThumb(dataType, idx) {
  const pool = THUMB_POOL;
  return pool[idx % pool.length];
}

// ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATATYPE_LABEL = {
  'optical_satellite': 'Optical',
  'optical_aerial':    'Aerial',
  'elevation':         'Elevation',
  'sar':               'SAR',
  'basemap':           'Basemap',
  'hyperspectral':     'Hyperspectral',
};

const rndI = (a,b) => Math.floor(a + Math.random()*(b-a+1));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REAL_LISTINGS ‚Äî –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
//
//  –ü–æ–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∏–Ω–≥–∞:
//    id         ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (—Å—Ç—Ä–æ–∫–∞)
//    provider   ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä ('Maxar', 'Airbus', 'ICEYE', ...)
//    product    ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ('Vantor-15cm', 'SkySat', ...)
//    type       ‚Äî 'optical' | 'sar'
//    dataType   ‚Äî 'optical_satellite' | 'optical_aerial' | 'elevation' | 'sar' | 'basemap'
//    dateStr    ‚Äî –¥–∞—Ç–∞ —Å—ä—ë–º–∫–∏ 'YYYY-MM-DD'
//    resCm      ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (—á–∏—Å–ª–æ, –Ω–∞–ø—Ä. 15)
//    bandCount  ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ—Å (—á–∏—Å–ª–æ, –Ω–∞–ø—Ä. 4)
//    cloud      ‚Äî –æ–±–ª–∞—á–Ω–æ—Å—Ç—å % (—á–∏—Å–ª–æ; 0 –¥–ª—è SAR)
//    nadir      ‚Äî off-nadir —É–≥–æ–ª –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
//    area       ‚Äî –ø–ª–æ—â–∞–¥—å –∑–∞–∫–∞–∑–∞ –≤ –∫–º¬≤ (—á–∏—Å–ª–æ)
//    price      ‚Äî —Ü–µ–Ω–∞ –∑–∞ –∫–º¬≤ (—á–∏—Å–ª–æ)
//    bounds     ‚Äî [[lat_min, lng_min], [lat_max, lng_max]]
//    thumb      ‚Äî URL –ø—Ä–µ–≤—å—é (null ‚Üí –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø—É–ª–∞)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REAL_LISTINGS = [
  {
    id: 'IMG-001',
    provider: 'Vantor', product: 'Vantor-15cm',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-02-21', resCm: 15, bandCount: 4,
    cloud: 23, nadir: 12, coverage: 92, area: 25.17, price: 18.00,
    bounds: [[53.327, -6.285], [53.355, -6.235]], thumb: null,
  },
  {
    id: 'IMG-002',
    provider: 'Vantor', product: 'Vantor-50cm',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-02-21', resCm: 50, bandCount: 4,
    cloud: 23, nadir: 8, coverage: 95, area: 25.17, price: 12.00,
    bounds: [[53.335, -6.230], [53.360, -6.185]], thumb: null,
  },
  {
    id: 'IMG-003',
    provider: 'Vantor', product: 'Vantor-50cm 8-Band',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-02-21', resCm: 50, bandCount: 8,
    cloud: 23, nadir: 8, coverage: 95, area: 25.17, price: 15.00,
    bounds: [[53.285, -6.165], [53.310, -6.115]], thumb: null,
  },
  {
    id: 'IMG-004',
    provider: 'Vantor', product: 'Vantor-30cm',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-02-21', resCm: 30, bandCount: 4,
    cloud: 23, nadir: 15, coverage: 88, area: 25.17, price: 16.00,
    bounds: [[53.355, -6.360], [53.382, -6.305]], thumb: null,
  },
  {
    id: 'IMG-005',
    provider: 'Maxar', product: 'WorldView-3 Standard',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-01-14', resCm: 31, bandCount: 8,
    cloud: 5, nadir: 10, coverage: 99, area: 112.40, price: 22.50,
    bounds: [[53.415, -6.270], [53.470, -6.170]], thumb: null,
  },
  {
    id: 'IMG-006',
    provider: 'Airbus', product: 'Pl√©iades Neo 4-Band',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2025-12-03', resCm: 30, bandCount: 4,
    cloud: 11, nadir: 7, coverage: 97, area: 68.90, price: 19.00,
    bounds: [[53.195, -6.115], [53.250, -6.040]], thumb: null,
  },
  {
    id: 'IMG-007',
    provider: 'ICEYE', product: 'ICEYE SAR Stripmap',
    type: 'sar', dataType: 'sar', source: 'satellite',
    dateStr: '2026-02-10', resCm: 100, bandCount: 2,
    cloud: 0, nadir: 30, coverage: 100, area: 42.00, price: 30.00,
    bounds: [[53.358, -6.268], [53.385, -6.205]], thumb: null,
  },
  {
    id: 'IMG-008',
    provider: 'Planet Labs', product: 'SkySat Collect',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-01-28', resCm: 50, bandCount: 4,
    cloud: 18, nadir: 22, coverage: 82, area: 42.80, price: 10.00,
    bounds: [[53.285, -6.400], [53.325, -6.340]], thumb: null,
  },
  {
    id: 'IMG-009',
    provider: 'Vexcel Imaging', product: 'UltraCam Aerial',
    type: 'optical', dataType: 'optical_aerial', source: 'aerial',
    dateStr: '2025-11-19', resCm: 10, bandCount: 4,
    cloud: 0, nadir: 3, coverage: 100, area: 55.00, price: 6.00,
    bounds: [[53.262, -6.245], [53.295, -6.180]], thumb: null,
  },
  {
    id: 'IMG-010',
    provider: 'Vantor', product: 'Vantor-15cm 8-Band',
    type: 'optical', dataType: 'optical_satellite', source: 'satellite',
    dateStr: '2026-02-05', resCm: 15, bandCount: 8,
    cloud: 2, nadir: 9, coverage: 98, area: 18.60, price: 25.00,
    bounds: [[53.370, -6.090], [53.395, -6.040]],
    thumb: null,
  },
  // ‚îÄ‚îÄ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ —Å—é–¥–∞ –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ ‚îÄ‚îÄ
];

let allResults = [];
let currentDetail = null;
let footprintLayers = [];

// ‚îÄ‚îÄ FILTER REAL LISTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateResults() {
  const dateFrom    = document.getElementById('dateFrom').value    || '2000-01-01';
  const dateTo      = document.getElementById('dateTo').value      || '2099-12-31';
  const resFilter   = document.getElementById('resolution').value;
  const maxCloud    = parseInt(document.getElementById('cloudCover').value);
  const minCoverage = parseInt(document.getElementById('coverage').value);
  const provFilter  = document.getElementById('provider').value;


  let aoiBounds = null;
  if (currentAOI) aoiBounds = currentAOI.getBounds();

  return REAL_LISTINGS.filter(item => {
    // Archive vs Tasking: tasking shows only future dates, archive shows past
    if (activeMode === 'tasking' && item.dateStr <= new Date().toISOString().slice(0,10)) return false;
    if (activeMode === 'archive' && item.dateStr > new Date().toISOString().slice(0,10)) return false;
    // Date range
    if (item.dateStr < dateFrom || item.dateStr > dateTo) return false;
    // Data type card
    if (activeDataType !== 'all' && item.dataType !== activeDataType) return false;
    // Resolution (resCm ‚Üí convert to metres for filter)
    const resM = item.resCm / 100;
    if (resFilter === 'high'   && resM >= 1)              return false;
    if (resFilter === 'medium' && (resM < 1 || resM > 3)) return false;
    if (resFilter === 'low'    && resM <= 3)              return false;
    // Cloud cover
    if (item.type === 'optical' && item.cloud > maxCloud) return false;
    // Coverage
    const itemCoverage = item.coverage ?? 100;
    if (itemCoverage < minCoverage) return false;
    // Provider
    if (provFilter !== 'all' && !item.provider.toLowerCase().startsWith(provFilter)) return false;
    // Spatial overlap
    if (aoiBounds) {
      const itemBounds = L.latLngBounds(item.bounds[0], item.bounds[1]);
      if (!aoiBounds.overlaps(itemBounds)) return false;
    }
    return true;
  }).map((item, idx) => ({ ...item, thumbIdx: idx }));
}

// ‚îÄ‚îÄ CANVAS THUMBNAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawThumb(canvas, item, w, h) {
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  if (item.type === 'sar') {
    const grd = ctx.createLinearGradient(0,0,w,h);
    grd.addColorStop(0,'#1a1a1a'); grd.addColorStop(0.4,'#3a3a3a');
    grd.addColorStop(0.7,'#555'); grd.addColorStop(1,'#222');
    ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
    for (let j=0;j<1200;j++) {
      const x=Math.random()*w, y=Math.random()*h, v=Math.random();
      ctx.fillStyle=`rgba(${v>.97?255:180},${v>.97?255:180},${v>.97?255:180},${v>.95?.9:.15})`;
      ctx.fillRect(x,y,1,1);
    }
    ctx.fillStyle='rgba(200,200,200,0.18)';
    for(let j=0;j<8;j++) ctx.fillRect(Math.random()*w*.8,Math.random()*h*.8,10+Math.random()*20,10+Math.random()*20);
  } else {
    const hue = item.hue;
    const grd = ctx.createLinearGradient(0,0,w,h);
    grd.addColorStop(0,`hsl(${hue},30%,18%)`);
    grd.addColorStop(0.5,`hsl(${hue+15},25%,28%)`);
    grd.addColorStop(1,`hsl(${hue-10},35%,14%)`);
    ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);
    for(let j=0;j<12;j++){
      ctx.fillStyle=`hsla(${80+Math.random()*60},40%,${25+Math.random()*20}%,0.5)`;
      ctx.fillRect(Math.random()*w,Math.random()*h,15+Math.random()*35,10+Math.random()*20);
    }
    ctx.strokeStyle='rgba(200,180,140,0.25)'; ctx.lineWidth=1;
    for(let j=0;j<4;j++){
      ctx.beginPath();
      ctx.moveTo(Math.random()*w,Math.random()*h);
      ctx.lineTo(Math.random()*w,Math.random()*h);
      ctx.stroke();
    }
    if (item.cloud > 20) {
      const cld = ctx.createRadialGradient(w*.3,h*.4,0,w*.3,h*.4,w*.5);
      cld.addColorStop(0,`rgba(255,255,255,${item.cloud/300})`);
      cld.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=cld; ctx.fillRect(0,0,w,h);
    }
  }
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runSearch() {
  footprintLayers.forEach(l => map.removeLayer(l));
  footprintLayers = [];
  closeDetail();
  const list = document.getElementById('resultsList');
  list.innerHTML = '<div style="display:flex;justify-content:center;padding:30px"><div class="spinner"></div></div>';
  setTimeout(() => {
    allResults = generateResults();
    allResults.sort((a,b) => new Date(b.dateStr)-new Date(a.dateStr));
    renderResults();
    renderFootprints();
  }, 400);
}

function fmtDate(str) {
  if (!str) return str;
  const d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function renderResults() {
  const list = document.getElementById('resultsList');
  document.getElementById('resultCount').textContent = allResults.length;
  if (!allResults.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><h4>No imagery found</h4><p>Try adjusting the filter parameters</p></div>`;
    return;
  }
  list.innerHTML = allResults.map(item => `
    <div class="result-card" id="card-${item.id}" onclick="selectItem('${item.id}')">
      <div class="card-thumb">
        <img src="${item.thumb || getThumb(item.dataType, item.thumbIdx)}"
             alt="${item.product}"
             onerror="this.style.display='none';this.parentElement.style.background='#1a1a1a'" />
        <span class="card-type type-${item.type}">${DATATYPE_LABEL[item.dataType] || (item.type==='sar'?'SAR':'OPT')}</span>
      </div>
      <div class="card-body">
        <div class="card-date">${fmtDate(item.dateStr)}</div>
        <div class="card-title">${item.product}</div>
        <div class="card-specs">
          <div class="card-spec-row"><span class="spec-key">${item.bandCount} Band</span></div>
          <div class="card-spec-row">
            <span class="spec-key">Resolution:</span>
            <span class="spec-val">${item.resCm}cm</span>
          </div>
          <div class="card-spec-row">
            <span class="spec-key">Order Area:</span>
            <span class="spec-val">${item.area} km¬≤</span>
          </div>
          ${item.type !== 'sar' ? `
          <div class="card-spec-row">
            <span class="spec-key">Cloud Cover:</span>
            <span class="spec-val">${item.cloud}%</span>
          </div>` : ''}
        </div>
      </div>
    </div>
  `).join('');
}

function sortResults() {
  const by = document.getElementById('sortSelect').value;
  if (by==='date')  allResults.sort((a,b)=>new Date(b.dateStr)-new Date(a.dateStr));

  if (by==='cloud') allResults.sort((a,b)=>a.cloud-b.cloud);
  if (by==='res')   allResults.sort((a,b)=>a.resCm-b.resCm);
  renderResults();
}

// ‚îÄ‚îÄ FOOTPRINTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFootprints() {
  allResults.forEach(item => {
    const color = item.type === 'sar' ? '#aaaaaa' : '#ffffff';
    const rect = L.rectangle(item.bounds, {
      color,
      weight: 1.5,
      opacity: 0.5,
      fillOpacity: 0.04,
      fillColor: color,
    }).addTo(map);
    rect.itemId = item.id;

    // Hover: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    rect.on('mouseover', function() {
      if (rect.itemId !== (currentDetail && currentDetail.id)) {
        this.setStyle({ fillOpacity: 0.18, weight: 2, opacity: 1 });
      }
      this.bringToFront();
    });
    rect.on('mouseout', function() {
      if (rect.itemId !== (currentDetail && currentDetail.id)) {
        this.setStyle({ fillOpacity: 0.04, weight: 1.5, opacity: 0.5 });
      }
    });

    rect.on('click', () => selectItem(item.id));

    // Tooltip —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ
    rect.bindTooltip(`
      <div style="font-family:'Inter',sans-serif;font-size:12px;line-height:1.6;padding:2px 0;">
        <div style="font-weight:700;font-size:13px;margin-bottom:3px;">${item.product}</div>
        <div style="color:#aaa;">${item.provider} &nbsp;¬∑&nbsp; ${item.dateStr}</div>
        <div style="color:#aaa;">Resolution: <span style="color:#fff">${item.resCm}cm</span></div>
        <div style="color:#aaa;">${item.bandCount} Band &nbsp;¬∑&nbsp; Cloud: <span style="color:#fff">${item.type==='sar'?'N/A':item.cloud+'%'}</span></div>
        <div style="color:#aaa;">Area: <span style="color:#fff">${item.area} km¬≤</span></div>
      </div>
    `, {
      sticky: false,
      opacity: 1,
      direction: 'right',
      offset: [16, 0],
      className: 'footprint-tooltip',
    });

    footprintLayers.push(rect);
  });
}

function highlightFootprint(id) {
  footprintLayers.forEach(l => {
    const active = l.itemId === id;
    l.setStyle({ fillOpacity: active?0.25:0.05, weight: active?2:1 });
  });
}

// ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectItem(id) {
  const item = allResults.find(r=>r.id===id);
  if (!item) return;
  currentDetail = item;

  document.querySelectorAll('.result-card').forEach(c=>c.classList.remove('selected'));
  const card = document.getElementById('card-'+id);
  if (card) { card.classList.add('selected'); card.scrollIntoView({block:'nearest',behavior:'smooth'}); }

  highlightFootprint(id);
  map.fitBounds(item.bounds, { padding:[40,40] });

  document.getElementById('detailTitle').textContent = item.product;

  const detailImg = document.getElementById('detailImg');
  detailImg.src = item.thumb || getThumb(item.dataType, item.thumbIdx);
  detailImg.alt = item.product;

  document.getElementById('detailBody').innerHTML = `
    <div class="detail-row"><span class="key">Image ID</span><span class="val">${item.id}</span></div>
    <div class="detail-row"><span class="key">Provider</span><span class="val">${item.provider}</span></div>
    <div class="detail-row"><span class="key">Product</span><span class="val">${item.product}</span></div>
    <div class="detail-row"><span class="key">Capture Date</span><span class="val">${fmtDate(item.dateStr)}</span></div>
    <div class="detail-row"><span class="key">Data Type</span><span class="val">${DATATYPE_LABEL[item.dataType] || '‚Äî'}</span></div>
    <div class="detail-row"><span class="key">Sensor Type</span><span class="val">${item.type==='sar'?'SAR':'Optical'}</span></div>
    <div class="detail-row"><span class="key">Resolution</span><span class="val">${item.resCm} cm</span></div>
    <div class="detail-row"><span class="key">Bands</span><span class="val">${item.bandCount} Band</span></div>
    <div class="detail-row"><span class="key">Cloud Cover</span><span class="val">${item.type==='sar'?'N/A':item.cloud+'%'}</span></div>
    <div class="detail-row"><span class="key">Source</span><span class="val" style="text-transform:capitalize;">${item.source || 'Satellite'}</span></div>
    <div class="detail-row"><span class="key">Coverage</span><span class="val">${item.coverage ?? 100}%</span></div>
    <div class="detail-row"><span class="key">Off-Nadir Angle</span><span class="val">${item.nadir}¬∞</span></div>
    <div class="detail-row"><span class="key">Order Area</span><span class="val">${item.area} km¬≤</span></div>
  `;

  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  currentDetail = null;
  footprintLayers.forEach(l=>l.setStyle({fillOpacity:0.05,weight:1}));
  document.querySelectorAll('.result-card').forEach(c=>c.classList.remove('selected'));
}

// ‚îÄ‚îÄ ENQUIRE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEnquire(item) {
  const ctx = document.getElementById('modalContext');
  const info = document.getElementById('modalContextInfo');
  if (item) {
    ctx.style.display = 'block';
    info.innerHTML = [
      item.product, item.provider, fmtDate(item.dateStr),
      item.resCm+'cm', item.bandCount+' Band',
      item.area+' km¬≤'
    ].map(v=>`<span class="modal-tag">${v}</span>`).join('');
  } else {
    ctx.style.display = 'none';
  }
  document.getElementById('modalBackdrop').classList.add('open');
}

function closeEnquire() {
  document.getElementById('modalBackdrop').classList.remove('open');
}

function handleBackdropClick(e) {
  if (e.target === document.getElementById('modalBackdrop')) closeEnquire();
}

function submitEnquiry() {
  const name  = document.getElementById('fName').value.trim();
  const lname = document.getElementById('lName').value.trim();
  const email = document.getElementById('fEmail').value.trim();
  if (!name || !lname || !email) {
    showToast('Please fill in required fields (Name, Email)');
    return;
  }
  closeEnquire();
  showToast('Enquiry sent! Our team will contact you shortly.');
  ['fName','fLname','fEmail','fOrg','fMessage'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('fUseCase').selectedIndex = 0;
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setTimeout(()=>{
  map.invalidateSize();
  map.setView([53.35, -6.30], 10);
  runSearch();
}, 300);
</script>

<!-- MOBILE FAB -->
<button class="mobile-search-fab" id="mobileFab" onclick="onFabClick()">Search Imagery</button>

<script>
// ‚îÄ‚îÄ MOBILE BOTTOM SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sheetOpen = false;
let activeSheetTab = 'filters';

function toggleSheet(forceState) {
  const panel = document.getElementById('leftPanel');
  const fab   = document.getElementById('mobileFab');
  sheetOpen = forceState !== undefined ? forceState : !sheetOpen;
  panel.classList.toggle('sheet-open', sheetOpen);
  if (fab) fab.classList.toggle('hidden', sheetOpen);
}

function switchSheetTab(tab) {
  activeSheetTab = tab;
  const isMobile = window.innerWidth < 768;
  document.getElementById('sheetFiltersContent').style.display = isMobile && tab !== 'filters' ? 'none' : '';
  document.getElementById('sheetResultsContent').style.display = isMobile && tab !== 'results'  ? 'none' : '';
  document.getElementById('tabFilters').classList.toggle('active', tab === 'filters');
  document.getElementById('tabResults').classList.toggle('active', tab === 'results');
  if (isMobile && !sheetOpen) toggleSheet(true);
}

function onFabClick() {
  toggleSheet(true);
}

// After search on mobile ‚Üí switch to Results tab
const _origRenderResults = window.renderResults;
if (typeof renderResults === 'function') {
  const __orig = renderResults;
  window.renderResults = function() {
    __orig.apply(this, arguments);
    if (window.innerWidth < 768) switchSheetTab('results');
  };
}

// Touch swipe down to close
(function() {
  const panel = document.getElementById('leftPanel');
  let startY = 0;
  panel.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, { passive: true });
  panel.addEventListener('touchend', e => {
    const dy = e.changedTouches[0].clientY - startY;
    if (dy > 60 && sheetOpen) toggleSheet(false);
  }, { passive: true });
})();
</script>
</body>
</html>
